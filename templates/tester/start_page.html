{% extends 'tester/base.html' %}

{% load static %}
{% block content %}
    <div class="container-fluid mb-10">
        <div class="row">
            <div class="col-md-12">
                <table class="table table-dark table-striped">
                    <thead>
                    <tr>
                        <th>Адрес</th>
                        <th>Тип</th>
                        <th>Контакт</th>
                        <th>Доп.Контакт</th>
                        <th>Приоритет</th>
                        <th>Логин</th>
                        <th>Оператор</th>
                        <th>Коментарий опера</th>
                        <th>Мастер</th>
                        <th>Коментарий мастера</th>
                        <th >Статус</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if perms.tester.master %}
                        {% for mst in master_ticket %}
                            {% if mst.status == True %}
                            <tr {% if mst.priority == 'Срочный' %}class="table-danger"{% elif mst.priority == 'Корпоративный' %}class="table-warning"{% endif %}>
                                <td class="text-start align-middle">{{ mst.get_full_address }}{% if mst.apartment %} кв
                                    {{ mst.apartment| default:'' }}{% endif %}</td>
                                <td class="text-start align-middle">{{ mst.type }}</td>
                                <td class="text-start align-middle">{{ mst.first_contact }}</td>
                                <td class="text-start align-middle">{{ mst.second_contact| default:"" }}</td>
                                {% if mst.priority == 'Срочный' %}
                                    <td class="align-middle">
                                        <div class="btn-group" style="width: 160px">
                                            <div class="btn btn-danger">Срочный</div>
                                        </div>
                                    </td>
                                {% elif mst.priority == 'Корпоративный' %}
                                    <td class="align-middle">
                                        <div class="btn-group" style="width: 160px">
                                            <div class="btn btn-warning">Корпоративный</div>
                                        </div>
                                    </td>
                                {% elif mst.priority %}
                                    <td class="align-middle">
                                        <div class="text-middle">{{ mst.priority }}</div>
                                    </td>
                                {% endif %}

                                <td class="text-start text-centre align-middle">{{ mst.login| default:'' }}</td>
                                <td class="text-center text-centre align-middle">{{ mst.operator.first_name }}</td>
                                <td class="text-center text-break align-middle" data-bs-toggle="tooltip"
                                    data-bs-placement="top" data-bs-custom-class="custom-tooltip"
                                    {% if mst.comment_operator %}data-bs-title="{{ mst.comment_operator }}"{% endif %}>{{ mst.comment_operator| slice:16 | default:'' }}</td>
                                <td class="text-center text-centre align-middle">{{ mst.master| default:'Не выбран' }}</td>
                                <td class="text-center text-centre align-middle" data-bs-toggle="tooltip"
                                    data-bs-placement="top" data-bs-custom-class="custom-tooltip"
                                    {% if mst.comment_master %}data-bs-title="{{ mst.comment_master }}"{% endif %}>{{ mst.comment_master| default:'' }}</td>
                                {% if mst.status == True %}
                                    <td class="align-middle">
                                        <div class="btn-group">
                                            <div class="btn btn-success">Открыта</div>
                                        </div>
                                    </td>
                                {% else %}
                                    <td class="align-middle">
                                        <div class="btn-group">
                                            <div class="btn btn-danger">Закрыта</div>
                                        </div>
                                    </td>

                                {% endif %}
                                <td>
                                    <div>
                                        <a href="{% url 'master_comment' mst.id %}"><button type="button" class="btn btn-primary">Действие</button></a>
                                        <button type="button" class="btn btn-secondary" data-bs-toggle="modal"
                                                data-bs-target="#MoveOn">Перекинуть
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if perms.tester.operator %}
                        {% for foo in obj %}
                            {% if foo.status == True %}
                    <tr {% if foo.priority == 'Срочный' %}class="table-danger"{% elif foo.priority == 'Корпоративный' %}class="table-warning"{% endif %}>
                        <td class="text-start align-middle">{{ foo.get_full_address }}{% if foo.apartment %} кв
                            {{ foo.apartment| default:'' }}{% endif %}</td>
                        <td class="text-start align-middle">{{ foo.type }}</td>
                        <td class="text-start align-middle">{{ foo.first_contact }}</td>
                        <td class="text-start align-middle">{{ foo.second_contact| default:"" }}</td>
                        {% if foo.priority == 'Срочный' %}
                            <td class="align-middle">
                                <div class="btn-group" style="width: 160px">
                                    <div class="btn btn-danger">Срочный</div>
                                </div>
                            </td>
                        {% elif foo.priority == 'Корпоративный' %}
                            <td class="align-middle">
                                <div class="btn-group" style="width: 160px">
                                    <div class="btn btn-warning">Корпоративный</div>
                                </div>
                            </td>
                        {% elif foo.priority %}
                            <td class="align-middle">
                                <div class="text-middle">{{ foo.priority }}</div>
                            </td>
                        {% endif %}

                        <td class="text-start text-centre align-middle">{{ foo.login| default:'' }}</td>
                        <td class="text-center align-middle">{{ foo.operator.first_name }}</td>
                        <td class="text-center text-break align-middle" data-bs-toggle="tooltip" data-bs-placement="top"
                            data-bs-custom-class="custom-tooltip"
                            {% if foo.comment_operator %}data-bs-title="{{ foo.comment_operator }}"{% endif %}>{{ foo.comment_operator| slice:16 | default:'' }}</td>
                        <td class="text-center align-middle" >{{ foo.master| default:'Не выбран' }}</td>
                        <td class="text-center align-middle" data-bs-toggle="tooltip" data-bs-placement="top"
                            data-bs-custom-class="custom-tooltip"
                            {% if foo.comment_master %}data-bs-title="{{ foo.comment_master }}"{% endif %}>{{ foo.comment_master| slice:16 | default:'' }}</td>
                        {% if foo.status == True %}
                            <td class="align-middle">
                                <div class="btn-group">
                                    <div class="btn btn-success">Открыта</div>
                                </div>
                            </td>
                        {% else %}
                            <td class="align-middle">
                                <div class="btn-group">
                                    <div class="btn btn-danger">Закрыта</div>
                                </div>
                            </td>
                        {% endif %}

                        <td class="align-middle">
                            <a href="{% url 'edit_ticket' foo.id %}">
                                <button type="button" class="btn btn-primary me-2">Изменить</button>
                            </a>
                            <div class="btn-group" role="group" aria-label="Button group with nested dropdown">
                                <div class="btn-group" role="group">
                                    <button id="btnGroupDrop1" type="button"
                                            class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown"
                                            aria-expanded="false">Действие
                                    </button>
                                    <ul class="dropdown-menu p-2"
                                        style="width: 160px; background-color: rgba(0,0,0,0.2)"
                                        aria-labelledby="btnGroupDrop1">
                                        <a href="{% url 'full-log' foo.id %}">
                                            <li class="align-middle p-1">
                                                <div class="btn btn-sm btn-danger w-100">Лог</div>
                                            </li>
                                        </a>
                                        <li class="align-middle p-1">
                                            <div class="btn btn-sm btn-warning w-100">Перекинуть</div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                        </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    </tbody>
                </table>
                <!-- Modal -->
            </div>
        </div>
    </div>
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Действие</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Типо полезная инфа
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть нахуй
                    </button>
                    {% for foo in obj %}
                        <a href="{% url 'edit_ticket' foo.id %}">
                            <button type="button" class="btn btn-primary">Изменить</button>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="MasterMove" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Добавьте коментарий</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" class="form-row">
                        {% csrf_token %}
                        <div class="col col-md-4">
                            {{ form.comment_master }}
                            {{ form.status }}
                        </div>
                        <div id="div_id_status" class="form-group mt-4">
                            <input type="submit" class="btn mt-2 ml-2 btn-primary" value="Добавить">
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть нахуй
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    </script>
{% endblock %}
{% block footer %}
    {% include 'tester/footer.html' %}
{% endblock %}